<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>מפת לחימה – דפדוף עדכונים</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- טעינת Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 6px 12px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    button {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <button id="prevBtn">⟵ יום קודם</button>
    <span id="dateLabel">---</span>
    <button id="nextBtn">יום הבא ⟶</button>
  </div>

  <script>
    const map = L.map('map').setView([48.5, 37.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const frontlineLayer = L.geoJSON(null, {
      style: { color: 'red', weight: 2 }
    }).addTo(map);

    let updates = [];
    let currentIndex = -1;

    async function fetchUpdates() {
      try {
        const res = await fetch('updates.json?ts=' + Date.now());
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        if (!data || !Array.isArray(data.updates) || data.updates.length === 0) {
          throw new Error('updates.json ריק או לא תקין');
        }

        updates = data.updates;
        currentIndex = updates.length - 1; // התחל מהעדכון האחרון
        await loadUpdate(currentIndex);
      } catch (err) {
        console.error(err);
        alert('לא נטענו עדכונים. ודא שקיים updates.json תקין, ונסה רענון קשיח (Ctrl+F5).');
      }
    }

    async function loadUpdate(index) {
      const entry = updates[index];
      const filename =
        entry.file ||
        (entry.files && entry.files.frontline) ||
        null;

      if (!filename) {
        alert('לא נמצא שם קובץ לעדכון');
        return;
      }

      const url = encodeURI(filename) + '?ts=' + Date.now();
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const geo = await res.json();

        frontlineLayer.clearLayers();
        L.geoJSON(geo, { style: { color: 'red', weight: 2 } })
          .addTo(frontlineLayer);

        document.getElementById('dateLabel').textContent = entry.date;
      } catch (err) {
        console.error(err);
        alert('שגיאה בטעינת קובץ: ' + filename);
      }
    }

    // ניווט
    document.getElementById('prevBtn').onclick = async () => {
      if (currentIndex > 0) {
        currentIndex--;
        await loadUpdate(currentIndex);
      }
    };
    document.getElementById('nextBtn').onclick = async () => {
      if (currentIndex < updates.length - 1) {
        currentIndex++;
        await loadUpdate(currentIndex);
      }
    };

    // התחלת טעינה
    fetchUpdates();
  </script>
</body>
</html>

