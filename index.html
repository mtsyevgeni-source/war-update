<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>מפת עדכונים – קו חזית והתקדמויות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZYo2w2Rj9u2j0Xk="
        crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-o9N1j7kG9G8zHn2fC9nPw3Y6f9G3C1fS2Q7lGStFv4M="
          crossorigin=""></script>

  <!-- חצים על קווים -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>

  <style>
    html, body, #map { height:100%; margin:0; }
    .panel{position:absolute;top:12px;right:12px;background:#fff;opacity:.98;padding:12px 14px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);font:14px/1.35 system-ui,Arial}
    .panel h3{margin:0 0 8px;font-size:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0}
    .legend{margin-top:8px;padding-top:8px;border-top:1px solid #e8e8e8;font-size:13px}
    .swatch{display:inline-block;width:14px;height:4px;margin-inline-start:6px;vertical-align:middle}
    .front{background:#000;height:6px}
    .ru{background:#d33}
    .ua{background:#1f6ef5}
    .unk{background:#666}
    .hint{color:#666;font-size:12px}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>שכבות</h3>
    <div class="row"><label><input type="checkbox" id="toggle-front" checked> קו חזית</label></div>
    <div class="row"><label><input type="checkbox" id="toggle-ru" checked> התקדמות רוסית</label></div>
    <div class="row"><label><input type="checkbox" id="toggle-ua" checked> התקדמות אוקראינית</label></div>
    <div class="row"><label><input type="checkbox" id="toggle-unk" checked> התקדמות (לא מסווג)</label></div>

    <h3 style="margin-top:10px">גלגל עכבר</h3>
    <div class="row">
      <label for="wheelStep">עוצמה</label>
      <input type="range" id="wheelStep" min="0.2" max="2" step="0.05" value="1">
      <span id="wheelVal">1.00×</span>
    </div>
    <div class="row"><label><input type="checkbox" id="invertWheel"> הפוך כיוון גלגל</label></div>
    <div class="hint">אם הזום “רץ” מהר מדי — הורד לעוצמה 0.6–0.8.</div>

    <div class="legend">
      <div><span class="swatch front"></span> קו חזית</div>
      <div><span class="swatch ru"></span> התקדמות רוסית</div>
      <div><span class="swatch ua"></span> התקדמות אוקראינית</div>
      <div><span class="swatch unk"></span> התקדמות (לא מסווג)</div>
      <div class="hint">קווים בני 14+ יום מוצגים דהויים (אם יש תאריך ב-properties).</div>
      <div id="lastUpdated" class="hint" style="margin-top:6px"></div>
    </div>
  </div>

  <script>
    // ---- קבצים כפי שיש בריפו שלך ----
    const FILES = ['advances1.json', 'advances2.json']; // נטען את שניהם וממיינים בזמן ריצה
    const FADE_AFTER_DAYS = 14;

    const STYLE = {
      front:  { color:'#000',    weight:4, opacity:1.0 },
      ru:     { color:'#d33',    weight:3, opacity:1.0 },
      ua:     { color:'#1f6ef5', weight:3, opacity:1.0 },
      unk:    { color:'#666',    weight:3, opacity:0.9 },
      fadedOpacity: 0.30
    };

    const map = L.map('map', { center:[48.7,35.5], zoom:6, scrollWheelZoom:false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

    function showUpdated(){
      document.getElementById('lastUpdated').textContent =
        'עודכן: ' + new Date().toLocaleString('he-IL');
    }
    showUpdated();

    // שליטת גלגל
    let wheelStep = 1.0, invertWheel = false;
    const wheelValEl = document.getElementById('wheelVal');
    document.getElementById('wheelStep').addEventListener('input', e=>{
      wheelStep = parseFloat(e.target.value);
      wheelValEl.textContent = wheelStep.toFixed(2)+'×';
    });
    document.getElementById('invertWheel').addEventListener('change', e=>{
      invertWheel = e.target.checked;
    });
    map.getContainer().addEventListener('wheel', (ev)=>{
      ev.preventDefault();
      const dir = (ev.deltaY>0?-1:1) * (invertWheel?-1:1);
      const next = map.getZoom() + dir*(0.5*wheelStep);
      map.setZoomAround(ev, next);
    }, { passive:false });

    // שכבות
    const frontLayer = L.layerGroup().addTo(map);
    const ruLayer = L.layerGroup().addTo(map);
    const uaLayer = L.layerGroup().addTo(map);
    const unkLayer = L.layerGroup().addTo(map);

    document.getElementById('toggle-front').onchange = e => e.target.checked ? frontLayer.addTo(map) : map.removeLayer(frontLayer);
    document.getElementById('toggle-ru').onchange    = e => e.target.checked ? ruLayer.addTo(map)   : map.removeLayer(ruLayer);
    document.getElementById('toggle-ua').onchange    = e => e.target.checked ? uaLayer.addTo(map)   : map.removeLayer(uaLayer);
    document.getElementById('toggle-unk').onchange   = e => e.target.checked ? unkLayer.addTo(map)  : map.removeLayer(unkLayer);

    // ----- זיהוי אוטומטי -----
    function isFrontByName(n){
      if(!n) return false;
      n = String(n).toLowerCase();
      return n.includes('front line') || n.includes('frontline') || n.includes('קו חזית') || n.includes('front ');
    }
    function hexToRGB(hex){
      if(!hex) return null;
      const m = String(hex).trim().match(/^#?([0-9a-f]{6})$/i);
      if(!m) return null;
      const v = parseInt(m[1],16);
      return { r:(v>>16)&255, g:(v>>8)&255, b:v&255 };
    }
    function isRedish(hex){
      const c = hexToRGB(hex); if(!c) return false;
      return c.r > 160 && c.r > c.g + 30 && c.r > c.b + 30;
    }
    function isBlueish(hex){
      const c = hexToRGB(hex); if(!c) return false;
      return c.b > 160 && c.b > c.r + 20 && c.b > c.g + 20;
    }
    function opacityByDate(f){
      try{
        const p=f.properties||{};
        const cand=p.date||p.Date||p.timestamp||p.when||p.start||p.Start||p.end;
        if(!cand) return 1.0;
        const d=new Date(cand); if(isNaN(d)) return 1.0;
        const days=(Date.now()-d.getTime())/86400000;
        return days>=FADE_AFTER_DAYS?STYLE.fadedOpacity:1.0;
      }catch{return 1.0}
    }
    function classifyFeature(f){
      const p=f.properties||{};
      const name=(p.name||p.Name||p.title||'')+' '+(p.description||'');
      const stroke = p.stroke || p.strokeColor || p.color || p['stroke-color'] || p['line-color'];

      if (isFrontByName(name) || (stroke && (stroke.toLowerCase()==='#000000' || stroke.toLowerCase()==='#000')))
        return 'front';

      const low = name.toLowerCase();
      if (isRedish(stroke) || low.includes('rus') || low.includes('russian') || low.includes('рос') || low.includes('רוס'))
        return 'ru';

      if (isBlueish(stroke) || low.includes('ukr') || low.includes('ukrain') || low.includes('укр') || low.includes('אוקרא'))
        return 'ua';

      return 'unk';
    }

    function addWithArrows(line, color, opacity, group){
      line.setStyle({ color, weight: line.options.weight||3, opacity });
      line.addTo(group);
      if (line instanceof L.Polyline && !(line instanceof L.Polygon)) {
        L.polylineDecorator(line, {
          patterns: [{
            offset: 25, repeat: 120,
            symbol: L.Symbol.arrowHead({ pixelSize: 10, pathOptions:{ color, weight:2, opacity } })
          }]
        }).addTo(group);
      }
    }

    function handleGeoJSON(geo){
      const fitBounds = L.latLngBounds();
      L.geoJSON(geo, {
        onEachFeature: (f, lyr) => {
          const cls = classifyFeature(f);
          const op  = opacityByDate(f);
          if (cls === 'front') {
            lyr.setStyle({ color: STYLE.front.color, weight: STYLE.front.weight, opacity: op });
            lyr.addTo(frontLayer);
          } else if (cls === 'ru') {
            addWithArrows(lyr, STYLE.ru.color, op, ruLayer);
          } else if (cls === 'ua') {
            addWithArrows(lyr, STYLE.ua.color, op, uaLayer);
          } else {
            addWithArrows(lyr, STYLE.unk.color, op, unkLayer);
          }
          if (lyr.getBounds) {
            const b=lyr.getBounds(); if (b.isValid()) fitBounds.extend(b);
          }
        },
        style: { weight:3 }
      });
      if (fitBounds.isValid()) map.fitBounds(fitBounds.pad(0.05));
    }

    // טוענים את שני הקבצים וממיינים
    Promise.allSettled(FILES.map(u=>fetch(u).then(r=>r.ok?r.json():Promise.reject(u+' missing'))))
      .then(results=>{
        let any=false;
        results.forEach(res=>{
          if(res.status==='fulfilled'){ handleGeoJSON(res.value); any=true; }
          else console.warn(res.reason);
        });
        if(!any) console.warn('לא נטען אף advances*.json');
      });
  </script>
</body>
</html>
