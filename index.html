<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ukraine War Updates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>
  <style>
    #map {
      width: 100%;
      height: 100vh;
      cursor: grab;
    }
    .leaflet-dragging #map {
      cursor: grabbing;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // אתחול המפה
    const map = L.map("map", {
      center: [48.4, 36.6],
      zoom: 7,
      zoomControl: true,
      scrollWheelZoom: true,
      wheelDebounceTime: 20,
      wheelPxPerZoomLevel: 120,
      inertia: true,
    });

    // שכבת בסיס
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // יצירת Panes (למנוע השתלטות שכבות על העכבר)
    map.createPane("frontPane");
    map.createPane("advancesPane");
    map.createPane("pointsPane");
    map.createPane("arrowsPane");

    map.getPane("frontPane").style.zIndex = 410;
    map.getPane("advancesPane").style.zIndex = 405;
    map.getPane("pointsPane").style.zIndex = 415;
    map.getPane("arrowsPane").style.zIndex = 420;

    map.getPane("frontPane").style.pointerEvents = "none";
    map.getPane("advancesPane").style.pointerEvents = "none";
    map.getPane("pointsPane").style.pointerEvents = "none";
    map.getPane("arrowsPane").style.pointerEvents = "none";

    // שכבת קו חזית (GeoJSON)
    const frontLayer = L.geoJSON(null, {
      style: {
        color: "#000",
        weight: 4,
        opacity: 0.95,
        smoothFactor: 1,
      },
      pane: "frontPane",
      interactive: false,
      bubblingMouseEvents: false,
    });

    fetch("advances2.json")
      .then((res) => res.json())
      .then((geo) => {
        frontLayer.addData(geo).addTo(map);
      });

    // שכבת קווי התקדמות
    const advancesLayer = L.geoJSON(null, {
      style: {
        color: "#000",
        weight: 1,
        opacity: 0.35,
        smoothFactor: 1.2,
      },
      pane: "advancesPane",
      interactive: false,
      bubblingMouseEvents: false,
    });

    fetch("advances2.json")
      .then((res) => res.json())
      .then((geo) => {
        advancesLayer.addData(geo);
      });

    // שכבת נקודות (advances1.json)
    const pointsLayer = L.geoJSON(null, {
      pointToLayer: (f, latlng) =>
        L.circleMarker(latlng, {
          radius: 3,
          color: "#2b6cb0",
          fillColor: "#2b6cb0",
          fillOpacity: 0.85,
          weight: 0.5,
        }),
      pane: "pointsPane",
      interactive: false,
      bubblingMouseEvents: false,
    });

    fetch("advances1.json")
      .then((res) => res.json())
      .then((geo) => {
        pointsLayer.addData(geo);
      });

    // שכבת עדכונים (updates.json עם דגלים)
    const icons = {
      ru: L.icon({ iconUrl: "ru.png", iconSize: [24, 18] }),
      ua: L.icon({ iconUrl: "ua.png", iconSize: [24, 18] }),
      nu: L.icon({ iconUrl: "nu.png", iconSize: [24, 18] }),
    };

    const updatesLayer = L.layerGroup();

    fetch("updates.json")
      .then((res) => res.json())
      .then((data) => {
        data.forEach((item) => {
          const marker = L.marker([item.lat, item.lng], {
            icon: icons[item.side] || icons.nu,
          }).bindPopup(
            `<b>${item.title}</b><br>${item.date}<br>${item.summary}`
          );
          updatesLayer.addLayer(marker);
        });
      });

    // בקרת שכבות
    const overlays = {
      "קו חזית": frontLayer,
      "קווי התקדמות": advancesLayer,
      נקודות: pointsLayer,
      "הצגת חיצים על הקווים": null, // נשאיר אופציה לחיצים בעתיד
      "עדכונים": updatesLayer,
    };

    L.control.layers(null, overlays, { collapsed: false }).addTo(map);

    // כברירת מחדל להציג את כל השכבות
    frontLayer.addTo(map);
    advancesLayer.addTo(map);
    pointsLayer.addTo(map);
    updatesLayer.addTo(map);
  </script>
</body>
</html>
