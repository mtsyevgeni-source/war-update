<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מפת עדכונים</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PolylineDecorator (חיצים על קווים) -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>

  <!-- Omnivore לטעינת KML ישירות ל-Leaflet -->
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <!-- Gesture handling לשליטה בגלגל -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css">
  <script src="https://unpkg.com/leaflet-gesture-handling"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .panel {
      position: fixed; top: 10px; right: 10px;
      z-index: 1000; background: rgba(255,255,255,.94);
      padding: 10px 12px; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      font-family: system-ui, Arial, sans-serif; font-size: 14px; line-height: 1.5;
      max-width: 340px;
    }
    .panel h3{margin:.2em 0 .4em;font-size:16px}
    .panel label{display:block;margin:.25em 0}
    .legend{margin-top:.4em;opacity:.9}
    .legend .chip{display:inline-block;width:14px;height:3px;vertical-align:middle;margin-left:6px;border-radius:2px}
    .chip-front{background:#000}
    .chip-adv{background:#000; opacity:.6}
  </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <h3>שכבות</h3>
  <label><input type="checkbox" id="cb-front" checked> קו חזית</label>
  <label><input type="checkbox" id="cb-adv" checked> קווי התקדמות</label>
  <label style="margin-right:18px"><input type="checkbox" id="cb-arrows"> הראה חיצים על הקווים</label>
  <label><input type="checkbox" id="cb-points" checked> נקודות</label>
  <hr>
  <h3>גלגל עכבר</h3>
  <label><input type="checkbox" id="cb-wheel"> פעיל</label>
  <label><input type="checkbox" id="cb-invert"> הפוך כיוון גלילה</label>
  <div class="legend">
    <div><span class="chip chip-front"></span>קו חזית (שחור עבה)</div>
    <div><span class="chip chip-adv"></span>קווי התקדמות (שחור דק, שקוף מעט)</div>
  </div>
</div>

<script>
  // ====== אתחול מפה ======
  const map = L.map('map', {
    center: [48.5, 35.5], // מרכז אוקראינה
    zoom: 7,
    gestureHandling: true,
    scrollWheelZoom: false, // ברירת מחדל כבוי – ניתן להדליק בתיבה
    zoomControl: true
  });

  // אריחי OSM
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // קבוצות שכבות
  const frontLayer    = L.layerGroup();   // קו חזית מתוך KML
  const advancesLayer = L.layerGroup();   // קווי התקדמות מתוך advances2.json
  const arrowsLayer   = L.layerGroup();   // חיצים לקווי התקדמות
  const pointsLayer   = L.layerGroup();   // נקודות מתוך advances1.json

  // ====== טעינת קו חזית מתוך advances.kml ======
  // נטען רק Feature-ים ששמם מכיל "Front line", ונצייר שחור עבה.
  const frontTarget = L.geoJSON(null, {
    filter: (feature) => {
      const name = (feature && feature.properties && (feature.properties.name || feature.properties.Title)) || '';
      return /front\s*line/i.test(name);
    },
    style: { color: '#000', weight: 4, opacity: 0.95 }
  });

  omnivore.kml('advances.kml', null, frontTarget)
    .on('ready', function() {
      frontTarget.addTo(frontLayer);
      frontLayer.addTo(map);
    })
    .on('error', function(e){ console.error('KML load error:', e.error); });

  // ====== טעינת קווי התקדמות (advances2.json) ======
  let advancesPolylines = [];

  fetch('advances2.json')
    .then(r => r.json())
    .then(geo => {
      const layer = L.geoJSON(geo, {
        style: { color:'#000', weight:2, opacity:0.45 }
      });
      layer.addTo(advancesLayer);
      advancesLayer.addTo(map);

      // שמירה עבור חיצים
      layer.eachLayer(l => { if (l instanceof L.Polyline) advancesPolylines.push(l); });
    })
    .catch(err => console.error('advances2.json load error:', err));

  // ====== חיצים לקווי התקדמות ======
  function rebuildArrows(enabled){
    arrowsLayer.clearLayers();
    if (!enabled || !map.hasLayer(advancesLayer)) return;

    advancesPolylines.forEach(line => {
      const decorator = L.polylineDecorator(line, {
        patterns: [
          { offset: '6%', repeat: 110, symbol: L.Symbol.arrowHead({
              pixelSize: 8, pathOptions: {color:'#000', fillOpacity: 0.9, weight: 1}
          })}
        ]
      });
      decorator.addTo(arrowsLayer);
    });
    arrowsLayer.addTo(map);
  }

  // ====== טעינת נקודות (advances1.json) ======
  fetch('advances1.json')
    .then(r => r.json())
    .then(geo => {
      const layer = L.geoJSON(geo, {
        pointToLayer: (feature, latlng) => {
          return L.circleMarker(latlng, {
            radius: 3.5, color: '#2b6cb0', fillColor: '#2b6cb0', fillOpacity: 0.85, weight: 0.5
          }).bindTooltip(feature?.properties?.name || '', {direction:'top', offset:[0,-2]});
        }
      });
      layer.addTo(pointsLayer);
      pointsLayer.addTo(map);
    })
    .catch(err => console.error('advances1.json load error:', err));

  // ====== טיפול בתיבת השליטה ======
  const $ = id => document.getElementById(id);

  $('cb-front').addEventListener('change', e => {
    if (e.target.checked) frontLayer.addTo(map);
    else map.removeLayer(frontLayer);
  });

  $('cb-adv').addEventListener('change', e => {
    if (e.target.checked) advancesLayer.addTo(map);
    else {
      map.removeLayer(advancesLayer);
      map.removeLayer(arrowsLayer);
      $('cb-arrows').checked = false;
    }
  });

  $('cb-arrows').addEventListener('change', e => {
    rebuildArrows(e.target.checked);
  });

  $('cb-points').addEventListener('change', e => {
    if (e.target.checked) pointsLayer.addTo(map);
    else map.removeLayer(pointsLayer);
  });

  // גלגל עכבר
  $('cb-wheel').addEventListener('change', e => {
    if (e.target.checked) map.scrollWheelZoom.enable();
    else map.scrollWheelZoom.disable();
  });

  // הפוך כיוון גלילה
  let inverted = false;
  $('cb-invert').addEventListener('change', e => { inverted = e.target.checked; });

  // מאזין לגלגל: אם “הפוך כיוון” מסומן – נהפוך את הכיוון ידנית
  map.getContainer().addEventListener('wheel', (ev) => {
    if (!map.scrollWheelZoom.enabled()) return;
    if (!inverted) return;
    ev.preventDefault();
    const delta = ev.deltaY || ev.wheelDelta;
    if (delta > 0) map.zoomIn(1, {animate:true});
    else map.zoomOut(1, {animate:true});
  }, {passive:false});
</script>
</body>
</html>
