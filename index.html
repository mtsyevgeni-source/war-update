<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>מפת עדכונים – קווי התקדמות + קו חזית</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html,body{height:100%;margin:0}
    body{overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    #map{height:100vh;width:100vw}

    #toolbar{
      position:fixed;top:8px;right:8px;z-index:1000;
      background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px 12px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);max-width:520px
    }
    .row{margin-top:.5rem}
    .small{font-size:12px;color:#666}
    .flex{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
    .slider{width:140px}
    .chip{width:22px;height:6px;border-radius:4px;display:inline-block;border:1px solid #0002;margin-inline:6px}
  </style>
</head>
<body>

<div id="toolbar" aria-label="לוח בקרה">
  <div class="flex">
    <label><input type="checkbox" id="layer-frontline" checked> קו חזית</label>
    <label><input type="checkbox" id="layer-lines" checked> קווי התקדמות</label>
    <label><input type="checkbox" id="layer-points" checked> נקודות</label>
    <span class="small">
      <span class="chip" style="background:#000"></span> חזית
      <span class="chip" style="background:#e53935"></span> רוסי
      <span class="chip" style="background:#1e88e5"></span> אוקראיני
      <span>• דהוי = >14 יום</span>
    </span>
  </div>

  <div class="row"><b>גלגל עכבר</b></div>
  <div class="flex">
    <label><input type="checkbox" id="wheel-enabled" checked> פעיל</label>
    <label><input type="checkbox" id="wheel-invert"> הפוך כיוון</label>
    <label>רגישות
      <input id="wheel-sens" class="slider" type="range" min="0.5" max="2" step="0.25" value="1">
    </label>
    <span id="wheel-sens-label" class="small">×1.00</span>
  </div>

  <div class="row">
    <button id="refresh">רענון עכשיו</button>
    <span id="status" class="small">ממתין לטעינה…</span><br>
    <span id="last" class="small"></span>
  </div>
</div>

<div id="map"></div>

<script>
/* ===== קבועים ===== */
const FADE_AFTER_DAYS = 14;
const COLOR_RU = '#e53935';
const COLOR_UA = '#1e88e5';
const COLOR_FL = '#000000';
const REFRESH_MS = 2 * 60 * 1000;

/* ===== מפה (גלגל של Leaflet מופעל כברירת מחדל) ===== */
const map = L.map('map', {
  zoomControl: true,
  scrollWheelZoom: true,              // <<<<< שיהיה עובד בוודאות
  wheelDebounceTime: 40,
  wheelPxPerZoomLevel: 80,
  touchZoom: 'center',
  zoomSnap: 0.25,
  zoomDelta: 0.25
}).setView([48.9, 31.4], 6);

// שכבת רקע
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

// למנוע גלילה בתוך התיבה
L.DomEvent.disableScrollPropagation(document.getElementById('toolbar'));

// תיחום אוקראינה
const boundsUkraine = L.latLngBounds([45.1,22.0],[52.6,40.3]);
map.fitBounds(boundsUkraine);

/* ===== שכבות ===== */
const frontlineGroup = L.layerGroup().addTo(map);
const linesGroup     = L.layerGroup().addTo(map);
const cluster        = L.markerClusterGroup();
map.addLayer(cluster);

/* ===== אייקונים לנקודות ===== */
const iconUA = L.icon({ iconUrl:'ua.png', iconSize:[28,20], iconAnchor:[14,10], popupAnchor:[0,-10] });
const iconRU = L.icon({ iconUrl:'ru.png', iconSize:[28,20], iconAnchor:[14,10], popupAnchor:[0,-10] });
const iconNE = L.icon({ iconUrl:'nu.png', iconSize:[24,24], iconAnchor:[12,12], popupAnchor:[0,-10] });
function iconBySide(s){ return s==='ua'?iconUA : s==='ru'?iconRU : iconNE; }

/* ===== שליטה בגלגל (Invert + רגישות) ===== */
const wheelEnabled = document.getElementById('wheel-enabled');
const wheelInvert  = document.getElementById('wheel-invert');
const wheelSens    = document.getElementById('wheel-sens');
const wheelLabel   = document.getElementById('wheel-sens-label');

let customWheelAttached = false;
function attachCustomWheel(){
  if(customWheelAttached) return;
  customWheelAttached = true;
  map._container.addEventListener('wheel', customWheelHandler, {passive:false});
}
function detachCustomWheel(){
  if(!customWheelAttached) return;
  customWheelAttached = false;
  map._container.removeEventListener('wheel', customWheelHandler, {passive:false});
}
function customWheelHandler(e){
  if(!wheelEnabled.checked) return;
  e.preventDefault();
  const sign = Math.sign(e.deltaY);
  const dir = wheelInvert.checked ? -sign : sign; // גלילה קדימה = התקרבות (כשלא הפוך)
  const step = 0.25 * parseFloat(wheelSens.value);
  const newZoom = map.getZoom() - dir * step;
  map.setZoomAround(e, newZoom);
}

// מצב התחלתי: להשתמש במנוע המובנה של Leaflet; אם מבקשים "הפוך כיוון" נעבור לידני
function applyWheelMode(){
  if(!wheelEnabled.checked){
    map.scrollWheelZoom.disable();
    detachCustomWheel();
    return;
  }
  if(wheelInvert.checked){
    map.scrollWheelZoom.disable(); // נשתלט
    attachCustomWheel();
  }else{
    detachCustomWheel();
    map.scrollWheelZoom.enable();  // ברירת מחדל – הכי חלק
  }
  wheelLabel.textContent = '×' + parseFloat(wheelSens.value).toFixed(2);
}
wheelEnabled.addEventListener('change', applyWheelMode);
wheelInvert .addEventListener('change', applyWheelMode);
wheelSens   .addEventListener('input', ()=> wheelLabel.textContent = '×' + parseFloat(wheelSens.value).toFixed(2));
applyWheelMode();

/* ===== עזרי עיצוב ===== */
function styleForLine(side, dateStr){
  const color = side==='ua'?COLOR_UA:COLOR_RU;
  let opacity = 0.95;
  if(dateStr){
    const days = (Date.now() - new Date(dateStr)) / (1000*60*60*24);
    if(days > FADE_AFTER_DAYS) opacity = 0.35;
  }
  return { color, weight: 3, opacity };
}
function styleFrontLine(){
  return { color: COLOR_FL, weight: 3.5, opacity: 0.9 };
}

/* ===== טעינה מה־JSON ===== */
const statusEl = document.getElementById('status');
const lastEl   = document.getElementById('last');
const btnRefresh = document.getElementById('refresh');

const layerFrontChk = document.getElementById('layer-frontline');
const layerLinesChk = document.getElementById('layer-lines');
const layerPointsChk= document.getElementById('layer-points');

let lastHash = null;

function clearLayers(){
  frontlineGroup.clearLayers();
  linesGroup.clearLayers();
  cluster.clearLayers();
}

async function loadData(initial=false){
  try{
    statusEl.textContent = 'טוען נתונים…';
    const res = await fetch('updates.json?t='+Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const hash = JSON.stringify(data);
    const changed = (hash !== lastHash); lastHash = hash;

    clearLayers();

    // קו חזית שחור
    if(layerFrontChk.checked && Array.isArray(data.frontline)){
      // אפשר כמה מקטעים – כל מקטע מצויר כ־polyline
      data.frontline.forEach(seg=>{
        if(Array.isArray(seg.coords) && seg.coords.length>=2){
          L.polyline(seg.coords, styleFrontLine()).addTo(frontlineGroup);
        }
      });
    }

    // קווי התקדמות (אדום/כחול, דהייה אחרי 14 יום)
    if(layerLinesChk.checked && Array.isArray(data.advances)){
      data.advances.forEach(seg=>{
        if(!Array.isArray(seg.coords) || seg.coords.length < 2) return;
        const st = styleForLine((seg.side||'ru').toLowerCase(), seg.date);
        L.polyline(seg.coords, st).addTo(linesGroup);
      });
    }

    // נקודות אירוע (רשות)
    if(layerPointsChk.checked && Array.isArray(data.points)){
      data.points.forEach(p=>{
        const lat = parseFloat(p.lat), lng = parseFloat(p.lng);
        if(isNaN(lat)||isNaN(lng)) return;
        const side = (p.side||'neutral').toLowerCase();
        const marker = L.marker([lat,lng], {icon: iconBySide(side)});
        let html = `<div class="popup"><h4>${p.title||'עדכון'}</h4>`;
        if(p.date) html += `<div class="small">${new Date(p.date).toLocaleDateString('he-IL')}</div>`;
        if(p.summary) html += `<p>${p.summary}</p>`;
        if(p.media?.type==='youtube' && p.media.id){
          html += `<div style="position:relative;padding-top:56.25%"><iframe style="position:absolute;inset:0;width:100%;height:100%;border:0" src="https://www.youtube.com/embed/${p.media.id}" allowfullscreen></iframe></div>`;
        } else if(p.media?.type==='link' && p.media.url){
          html += `<p><a href="${p.media.url}" target="_blank" rel="noopener">לצפייה במקור</a></p>`;
        }
        html += `</div>`;
        marker.bindPopup(html, {maxWidth:360});
        cluster.addLayer(marker);
      });
    }

    lastEl.textContent = 'עודכן: ' + new Date().toLocaleTimeString('he-IL');
    statusEl.textContent = changed ? 'נמצא עדכון חדש' : (initial ? 'נטען' : 'אין שינוי');
  }catch(err){
    console.error(err);
    statusEl.textContent = 'שגיאה בטעינה';
  }
}

btnRefresh.addEventListener('click', ()=>loadData(false));
layerFrontChk.addEventListener('change', ()=>loadData(false));
layerLinesChk.addEventListener('change', ()=>loadData(false));
layerPointsChk.addEventListener('change', ()=>loadData(false));

loadData(true);
setInterval(()=>loadData(false), REFRESH_MS);
</script>
</body>
</html>

